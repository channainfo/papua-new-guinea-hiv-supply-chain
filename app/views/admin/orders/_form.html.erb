<%= simple_form_for [:admin, @order], :html => { :class => 'form-horizontal' } do |f| %>
  <%= f.error_notification %>
  <div class='row'>
    <div class='span4' >
      <%= f.input :site_id, :collection => Site.all.map{|site| [site.name, site.id]},
                         :include_blank => 'Select a Site'
                         %>
    </div>

    <div class='span3'>
      <%= f.input :order_date, :as => 'date_time_picker', 
                               :label => 'Order Create' ,
                               :input_html => {:class => 'datepicker-fit'}

                               %>   
    </div>

    <div class='span3'>
        <%= f.input :date_submittion, :as => 'date_time_picker', 
                                      :label => 'Order Received',
                                      :input_html => { :class  => 'datepicker-fit'} 

                                      %> 
    </div>
    <div class='span2' style ='text-align:center;' >
      <%= f.submit 'Save order', :class => 'btn btn-primary' %>
    </div>

  </div>

  <% i = 0 %>
  <%=f.simple_fields_for :order_lines do |order_line| %>
    <% if @order.order_lines[i].arv_type == CommodityCategory::TYPES_DRUG %>
        <%=content_for :drug do  %>
          <%= render :partial => "order_line_row_drug", :locals => { 
              :order_line_record => @order.order_lines[i],
              :order_line => order_line
            } %>
        <% end %>    
    <% elsif @order.order_lines[i].arv_type == CommodityCategory::TYPES_KIT %>  
        <%=content_for :kit do %>
          <%= render :partial => "order_line_row_kit", :locals => { 
              :order_line_record => @order.order_lines[i],
              :order_line => order_line
            } %>
        <% end %>
    <% end %>  
    <% i += 1 %>
  <% end %>


  <div class="tabbable"> 
    <ul class="nav nav-tabs">
      <li class="active">
        <a href="#drug" data-toggle="tab">Drugs</a>
      </li>
      <li> 
        <a href="#kit" data-toggle="tab">Kits</a>
      </li>
    </ul>

    <div class="tab-content">
      <div class="tab-pane active" id="drug">
        <h4> Drug Commodities </h4>
        <%= render :partial => 'order_line_table_drug', :locals => {:body => yield(:drug) } %>
      </div>
      <div class="tab-pane" id="kit">
         <h4> Kit Commodities </h4>
         <%= render :partial => 'order_line_table_kit', :locals => {:body => yield(:kit) } %>
      </div>
    </div>
  </div>

  <div class="form-actions">
    <%= f.submit 'Save Order', :class => 'btn btn-primary' %>
    <%= link_to 'Cancel', admin_provinces_path, :class => 'btn' %>
  </div>
<% end %>

<script>
  function handleSiteUser(){
    $('#order_site').on('change', function(){
       var site = $(this).val();
       if(!site){
          removeUsers();
          return ;
       }

       var url  = '/admin/sites/' + site + '/users' 
       $.ajax({
          url : url,
          method : 'GET',
          dataType : 'json',
          success: function(response){
             removeUsers();
             $selectElm = $('#order_user_place_order') ;
             for(var i=0; i< response.length; i++){
                   value = response[i][1];
                   text  = response[i][0];
                   var option = "<option value='"+ value +"' >" + text + " </option>";
                   $selectElm.append(option);
                 }
          }
       })


    });
  }

  function removeUsers(){
      $("#order_user_place_order option[value !='']" ).remove();
  }

  $(function(){
    handleSiteUser();
  });
</script>
